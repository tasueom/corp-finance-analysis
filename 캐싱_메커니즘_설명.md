# 기업 코드 검색 최적화: 기존 방식 vs 새 방식

## 📊 기존 방식 (매번 API 호출)

### 동작 흐름
```
사용자가 "삼성" 검색
    ↓
1. Flask 서버가 요청 받음
    ↓
2. DART API 호출 시작
   - URL: https://opendart.fss.or.kr/api/corpCode.xml?crtfc_key={API_KEY}
   - 네트워크 요청 (약 1-2초 소요)
    ↓
3. ZIP 파일 다운로드 (약 2-3MB)
   - 전체 기업 목록 (약 30,000개 기업)
   - 네트워크 전송 시간 (약 1-2초)
    ↓
4. 메모리에서 ZIP 압축 해제
   - io.BytesIO로 메모리 스트림 처리
   - 압축 해제 시간 (약 0.5초)
    ↓
5. XML 파일 파싱
   - ElementTree로 XML 파싱
   - 파싱 시간 (약 0.5초)
    ↓
6. 순차 검색 (Linear Search)
   - 30,000개 기업을 하나씩 확인
   - "삼성"이 포함된 기업 찾기
   - 검색 시간 (약 0.1-0.5초)
    ↓
7. 결과 반환
   - 검색된 기업 목록 반환
```

### 문제점
- ⏱️ **매번 3-5초 소요**: 사용자가 검색할 때마다 전체 과정 반복
- 🌐 **네트워크 부하**: 동시에 여러 사용자가 검색하면 API 호출 폭증
- 💰 **API 할당량 낭비**: 같은 데이터를 반복 다운로드
- 🐌 **느린 응답 속도**: 사용자 경험 저하

---

## ⚡ 새 방식 (메모리 캐싱)

### 동작 흐름

#### A. 서버 시작 시 (한 번만 실행)
```
Flask 앱 시작
    ↓
1. 백그라운드 스레드 시작
   - 메인 프로세스와 별도로 실행
   - 사용자 요청을 블로킹하지 않음
    ↓
2. DART API 호출 (한 번만)
   - 전체 기업 목록 다운로드
   - ZIP 파일 다운로드 및 파싱
    ↓
3. 메모리에 캐시 저장
   - _corp_code_cache: {"삼성전자": "00126380", ...}
   - _corp_list_cache: [{"corp_name": "삼성전자", "corp_code": "00126380"}, ...]
   - _cache_loaded = True 설정
    ↓
4. 캐시 로딩 완료
   - 약 30,000개 기업 정보가 메모리에 저장됨
   - 이후 모든 검색은 이 캐시 사용
```

#### B. 사용자 검색 시 (매우 빠름)
```
사용자가 "삼성" 검색
    ↓
1. Flask 서버가 요청 받음
    ↓
2. 캐시 확인
   - _cache_loaded == True 확인
    ↓
3. 메모리에서 검색 (즉시)
   - _corp_list_cache 리스트를 순회
   - "삼성"이 포함된 기업 찾기
   - 검색 시간: 수 밀리초 (0.001초 이하)
    ↓
4. 결과 반환
   - 검색된 기업 목록 즉시 반환
```

### 장점
- ⚡ **즉시 응답**: 메모리에서 검색하므로 매우 빠름 (수 밀리초)
- 🌐 **네트워크 부하 없음**: API 호출 없이 메모리에서만 조회
- 💰 **API 할당량 절약**: 서버 시작 시 한 번만 호출
- 🚀 **확장성**: 동시에 수백 명이 검색해도 빠름
- 📦 **메모리 효율**: 약 30,000개 기업 정보는 약 5-10MB 정도 (매우 작음)

---

## 🔄 비교표

| 항목 | 기존 방식 | 새 방식 |
|------|----------|--------|
| **응답 시간** | 3-5초 | 수 밀리초 (0.001초 이하) |
| **API 호출** | 매번 호출 | 서버 시작 시 1회만 |
| **네트워크 사용** | 매번 다운로드 (2-3MB) | 없음 |
| **동시 사용자 처리** | 느림 (각자 API 호출) | 빠름 (공유 캐시) |
| **메모리 사용** | 거의 없음 | 약 5-10MB (매우 작음) |
| **서버 재시작 시** | 즉시 사용 가능 | 캐시 로딩 필요 (수 초) |

---

## 💡 핵심 아이디어

**"한 번 다운로드해서 메모리에 저장해두고, 계속 재사용하자!"**

- 기업 코드 목록은 자주 변경되지 않음 (하루에 한 번 정도)
- 메모리는 빠르지만, 네트워크는 느림
- 같은 데이터를 반복 다운로드하는 것은 비효율적

---

## ⚠️ 주의사항

1. **캐시 로딩 중**: 서버 시작 직후 수 초간은 검색 결과가 비어있을 수 있음
2. **서버 재시작**: 캐시가 초기화되므로 재시작 시 다시 로딩됨
3. **데이터 갱신**: 기업 목록이 업데이트되면 서버 재시작 필요 (또는 주기적 갱신 로직 추가 가능)

