{% extends "layout.html" %}

{% block title %}
재무제표 비교
{% endblock %}

{% block content %}
<h2>재무제표 비교 분석</h2>
<script>
    const corpList = {{ corp_list | tojson }};
</script>
<div class="comparison-container">
    <form method="POST" class="compare-form" id="compare-form">

        <div id="compare-box">
            <!-- 기본 비교 행 -->
            <div class="compare-row row-box">
                <div>
                    <select name="corp_name" onchange="loadYears(this)">
                        <option disabled hidden {% if not selected_corp %}selected{% endif %}>기업 선택</option>
                        {% for corp in corp_list %}
                        <option value="{{ corp[0] }}" {% if selected_corp==corp[0] %}selected{% endif %}>{{ corp[0] }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <select name="year">
                        <!-- 자동 로딩 -->
                    </select>
                </div>
            </div>
        </div>

        <button type="button" id="add-btn" class="btn-secondary">+ 비교 대상 추가</button>
        <button type="submit" class="btn-primary">비교하기</button>
    </form>
</div>

{% if result %}
<h3>비교 결과표</h3>

<div class="table-container">
    <table class="compare-table">
        <thead>
            <tr>
                {% for col in columns %}
                <th>{{ col }}</th>
                {% endfor %}
            </tr>
        </thead>

            <tbody>
                {% for row in result %}
                <tr>
                    {% for col in columns %}
                        {% set val = row[col] %}

                        {% if col == "account_nm" %}
                            <!-- 계정명은 그대로 -->
                            <td>{{ val }}</td>

                        {% elif "차이" in col %}
                            <!-- 차이 금액: 단위 변환 + 색상 -->
                            <td style="color:{% if val > 0 %}#27ae60{% elif val < 0 %}#c0392b{% else %}#7f8c8d{% endif %}; font-weight:600;">
                                {{ val | krnum }}
                            </td>

                        {% elif "증감률" in col %}
                            <!-- 증감률: % 표시 + 색상 -->
                            <td style="color:{% if val > 0 %}#27ae60{% elif val < 0 %}#c0392b{% else %}#7f8c8d{% endif %}; font-weight:600;">
                                {% if val is none %}
                                    -
                                {% else %}
                                    {{ val | round(2) }}%
                                {% endif %}
                            </td>

                        {% else %}
                            <!-- 일반 금액 처리 (억/조 단위 변환) -->
                            <td>{{ val | krnum }}</td>
                        {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>

    </table>
</div>
{% endif %}

<hr style="margin: 40px 0;">


<!---------------------------------------------수정한곳--------------------------------------->
<h3>비교 차트 영역</h3>

<div class="chart-container" style="
    margin-top: 20px;
    padding: 20px;
    background: #ffffff;
    border: 1px solid #ddd;
    border-radius: 8px;
">
    <canvas id="comparisonChart"></canvas>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 차트 데이터를 전역 변수로 설정 (compare-chart.js에서 사용)
window.chartData = {{ chart_data | default({}) | tojson | safe }};
</script>
<script src="{{ url_for('static', filename='js/chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/compare.js') }}"></script>
{% endblock %}
